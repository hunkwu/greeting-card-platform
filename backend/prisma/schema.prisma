// Prisma schema for Greeting Card platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id                    String   @id @default(uuid())
  email                 String   @unique
  passwordHash          String?  @map("password_hash")
  displayName           String?  @map("display_name")
  avatarUrl             String?  @map("avatar_url")
  language              String   @default("en")
  country               String?  // GEO: 用户所在国家
  subscriptionTier      String   @default("free") @map("subscription_tier")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // 关系
  cards                Card[]
  subscriptions        Subscription[]
  favorites            Favorite[]
  collaborations       Collaboration[]
  
  @@map("users")
}

// 模板表
model Template {
  id              String   @id @default(uuid())
  name            String
  category        String
  tags            String[]
  previewImageUrl String   @map("preview_image_url")
  designData      Json     @map("design_data") // Fabric.js JSON
  isPremium       Boolean  @default(false) @map("is_premium")
  language        String   @default("en")
  country         String?  // GEO: 特定国家的模板
  isUniversal     Boolean  @default(false) @map("is_universal") // GEO: 通用模板
  downloadsCount  Int      @default(0) @map("downloads_count")
  createdAt       DateTime @default(now()) @map("created_at")

  // 关系
  cards      Card[]
  favorites  Favorite[]

  @@index([category])
  @@index([language])
  @@index([country])
  @@map("templates")
}

// 贺卡表
model Card {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  templateId   String?  @map("template_id")
  title        String
  designData   Json     @map("design_data") // Fabric.js JSON
  thumbnailUrl String?  @map("thumbnail_url")
  shareUrl     String   @unique @map("share_url")
  shareCount   Int      @default(0) @map("share_count")
  viewCount    Int      @default(0) @map("view_count")
  isPublic     Boolean  @default(false) @map("is_public")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关系
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  template       Template?       @relation(fields: [templateId], references: [id])
  collaborations Collaboration[]

  @@index([userId])
  @@index([shareUrl])
  @@index([createdAt(sort: Desc)])
  @@map("cards")
}

// 订阅表
model Subscription {
  id                   String   @id @default(uuid())
  userId               String   @map("user_id")
  stripeSubscriptionId String?  @unique @map("stripe_subscription_id")
  paypalSubscriptionId String?  @unique @map("paypal_subscription_id")
  plan                 String   // 'monthly', 'quarterly', 'yearly'
  status               String   // 'active', 'cancelled', 'past_due', 'expired'
  currentPeriodStart   DateTime @map("current_period_start")
  currentPeriodEnd     DateTime @map("current_period_end")
  cancelAtPeriodEnd    Boolean  @default(false) @map("cancel_at_period_end")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // 关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

// 收藏表
model Favorite {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  templateId String   @map("template_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // 关系
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([userId, templateId])
  @@map("favorites")
}

// 协作表
model Collaboration {
  id         String   @id @default(uuid())
  cardId     String   @map("card_id")
  userId     String   @map("user_id")
  permission String   // 'view', 'edit'
  createdAt  DateTime @default(now()) @map("created_at")

  // 关系
  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cardId, userId])
  @@map("collaborations")
}

// AI使用记录表（用于限流）
model AIUsage {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // 'text_generation', 'design_suggestion'
  tokensUsed Int     @map("tokens_used")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("ai_usage")
}
